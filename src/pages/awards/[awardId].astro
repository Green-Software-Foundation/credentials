---
import { Card } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import Cta from "@/components/cta.astro";
import PageLayout from "@/layouts/PageLayout.astro";

import BookIcon from "@/assets/icons/book.svg";
import WhatWillYouLearnIcon from "@/assets/icons/what-youll-learn.svg";
import RoundedCheckIcon from "@/assets/icons/rounded-check.svg";

import CalendarIcon from "@/assets/icons/calendar.svg";
import DownloadIcon from "@/assets/icons/download.svg";
import ShareLinkIcon from "@/assets/icons/share-link.svg";
import ExternalLinkIcon from "@/assets/icons/external-link.svg";

import LinkedInIcon from "@/assets/icons/linkedin.svg";
import XIcon from "@/assets/icons/x.svg";
import FacebookIcon from "@/assets/icons/facebook.svg";
import WhatsappIcon from "@/assets/icons/whatsapp.svg";
import CopyIcon from "@/assets/icons/copy.svg";

import { getCredentialBySlug } from "@/data/credentials";
import { getAwardById } from "@/data/awards";

const { awardId } = Astro.params;

if (!awardId) {
  return Astro.redirect("/404");
}

// Fetch the award data dynamically based on the ID
const award = await getAwardById(awardId);

if (!award) {
  return Astro.redirect("/404");
}

const credential = await getCredentialBySlug(award.credentialSlug);

if (!credential) {
  return Astro.redirect("/404");
}

const issuedDate = new Date(award.issuedAt);
	const issuedDateFormatted = issuedDate.toLocaleDateString("en-US", {
	  year: "numeric",
	  month: "long",
	  day: "numeric",
	});

	const publicSiteUrl =
	  import.meta.env.PUBLIC_SITE_URL ||
	  process.env.PUBLIC_SITE_URL ||
	  process.env.URL ||
	  process.env.DEPLOY_URL ||
	  process.env.DEPLOY_PRIME_URL;

	const shareUrl = publicSiteUrl
	  ? new URL(`/awards/${award.id}`, publicSiteUrl).href
	  : Astro.url.href;

	const shareText = `I earned the ${credential.title} badge from the Green Software Foundation.`;
	const encodedShareUrl = encodeURIComponent(shareUrl);
	const encodedShareText = encodeURIComponent(shareText);
	const whatsappText = encodeURIComponent(`${shareText} ${shareUrl}`);

	const shareLinks = {
	  linkedin: `https://www.linkedin.com/sharing/share-offsite/?url=${encodedShareUrl}`,
	  x: `https://twitter.com/intent/tweet?text=${encodedShareText}&url=${encodedShareUrl}`,
	  facebook: `https://www.facebook.com/sharer/sharer.php?u=${encodedShareUrl}&quote=${encodedShareText}`,
	  whatsapp: `https://wa.me/?text=${whatsappText}`,
	};
	---

<PageLayout
  title={`${award.recipientName} - ${credential.title} - Green Software Foundation`}
  mainClass="py-10 md:py-14 lg:py-16"
>
  <section class="container">
    <Card className="pb-8 md:pb-16">
      <div class="flex flex-col gap-3 px-3 pt-3 md:flex-row md:items-center md:justify-between">
        <p class="text-xs text-primary-darker">
          Verification Code:
          <span class="font-bold">{award.id}</span>
        </p>

        <Button variant="outline" disabled={!award.certificateUrl}>
          <a
            href={award.certificateUrl ||
              `https://bxaqfblvdhkpxghjptyr.supabase.co/storage/v1/object/public/certificates/awards/${award.id}.pdf`}
            download={`${award.id}.pdf`}
            target="_blank"
            rel="noopener noreferrer"
            class="flex items-center gap-2"
          >
            <DownloadIcon />
            Download certificate
          </a>
        </Button>
      </div>
      <div class="flex flex-col items-center justify-center text-center">
        <div class="shrink-0 px-16 py-7">
          <img
            src="/assets/card-badge.svg"
            alt={`${credential.title} badge`}
            class="size-40 object-contain lg:size-53"
          />
        </div>

        <div>
          <h1 class="text-3xl font-extrabold text-primary md:text-[40px]">
            {award.recipientName}
          </h1>
          <p class="mt-4">has successfully completed the course</p>
          <p class="mt-4 text-2xl font-extrabold text-primary md:text-4xl">
            {credential.title}
          </p>
          <p class="mt-4 flex items-center justify-center gap-2 text-sm text-gray-darker">
            <CalendarIcon /> Issued:
            <span>{issuedDateFormatted}</span>
          </p>
        </div>
      </div>
    </Card>

    <div class="mt-4 flex w-full flex-col gap-4 lg:flex-row">
      <Card className="p-8 lg:basis-[75%]">
        <div class="space-y-3">
          <h2 class="flex items-center gap-2 text-xl font-bold text-primary md:text-2xl">
            <BookIcon />
            About
          </h2>
          <div class="space-y-3 text-sm text-gray-darker md:text-base">
            {credential.aboutParagraphs.map((paragraph) => <p>{paragraph}</p>)}
          </div>
        </div>

        <div class="my-3 h-px w-full bg-gray"></div>

        <h3 class="flex items-center gap-2 text-xl font-bold text-primary md:text-2xl">
          <WhatWillYouLearnIcon />
          What You&apos;ll Learn
        </h3>
        <ul class="mt-4 text-gray-darker">
          {
            credential.whatYoullLearn.map((item) => (
              <li class="mt-4 flex items-center gap-3 first:mt-0">
                <RoundedCheckIcon />
                <span>{item}</span>
              </li>
            ))
          }
        </ul>
      </Card>

      <Card className="h-fit p-6 lg:basis-[25%]">
        <Button className="w-full font-extrabold"
          ><a href="#" class="flex items-center gap-2"
            >Take the course <ExternalLinkIcon />
          </a></Button
        >

        <Button className="mt-3 w-full font-extrabold" variant="outline">
          <a href={`/credentials/${credential.slug}`}>Credential info</a>
        </Button>

        <div class="my-3 h-px w-full bg-gray"></div>

        <p class="flex items-center gap-3 text-sm font-extrabold text-primary">
          <ShareLinkIcon />
          Share Achievement
        </p>

	      <div class="mt-3 flex items-center gap-2">
	          {
	            [
	              {
	                id: "linkedin",
	                Icon: LinkedInIcon,
	                href: shareLinks.linkedin,
	                external: true,
	                label: "Share on LinkedIn",
	              },
	              {
	                id: "x",
	                Icon: XIcon,
	                href: shareLinks.x,
	                external: true,
	                label: "Share on X",
	              },
	              {
	                id: "facebook",
	                Icon: FacebookIcon,
	                href: shareLinks.facebook,
	                external: true,
	                label: "Share on Facebook",
	              },
	              {
	                id: "whatsapp",
	                Icon: WhatsappIcon,
	                href: shareLinks.whatsapp,
	                external: true,
	                label: "Share on WhatsApp",
	              },
	              {
	                id: "copy",
	                Icon: CopyIcon,
	                href: "#",
	                external: false,
	                label: "Copy link",
	              },
	            ].map(({ id, Icon, href, external, label }) => (
	              <Button className="p-2" key={id}>
	                <a
	                  href={href}
	                  aria-label={label}
	                  target={external ? "_blank" : undefined}
	                  rel={external ? "noopener noreferrer" : undefined}
	                  data-copy-link={id === "copy" ? shareUrl : undefined}
	                >
	                  <Icon />
	                </a>
	              </Button>
	            ))
	          }
	        </div>

	        <script is:inline>
	          const copyLinkEl = document.querySelector('[data-copy-link]');
	          if (copyLinkEl) {
	            copyLinkEl.addEventListener('click', async (event) => {
	              event.preventDefault();
	              const link = copyLinkEl.getAttribute('data-copy-link');
	              if (!link) return;
	              try {
	                await navigator.clipboard.writeText(link);
	              } catch {
	                const input = document.createElement('input');
	                input.value = link;
	                document.body.appendChild(input);
	                input.select();
	                document.execCommand('copy');
	                input.remove();
	              }
	            });
	          }
	        </script>
	
	        <Button className="mt-3 w-full font-extrabold" variant="outline">
	          Add to My LinkedIn Profile
	        </Button>
      </Card>
    </div>
  </section>

  <Cta
    sectionId="ready-to-build"
    sectionClass="pt-10 md:pt-12 lg:pt-16"
    title="Ready to Build Sustainable Software?"
    description="Take the next step in your green software journey. Get certified, access exclusive resources, and join thousands of practitioners making a real impact on our planet's future."
    buttonText="See all certs"
    buttonVariant="primary"
    buttonHref="/#credentials"
    imageSrc="/assets/ready-to-build.svg"
    imageAlt="Ready to build sustainable software"
  />
</PageLayout>
